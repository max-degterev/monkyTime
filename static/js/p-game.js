// Generated by CoffeeScript 1.4.0
(function(){(function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;Date.now||(Date.now=function(){return+(new Date)});h=[];u=0;e.ajax({url:"/api/v1.1/game/score.json",type:"GET",success:function(e){if(e.length){h=e;return u=h[0].score}}});c={debug:!0,lives:6,garbage:5e3,player:{delay:80,accel:1200,limit:1600},modes:{time:2e4,speeds:[5,8,12,16,23,25],accelerated:3,randomized:6,vector:2},sudden:{active:!0,objects:["banana","banana","bomb","bomb","heart"],num:15},transform:S.utils.supports("transform"),objects:{banana:{"class":"banana",chance:.25,num:7,points:1,lives:0,accel:1},bomb:{"class":"bomb",chance:.005,num:3,points:-5,lives:-2,accel:2},heart:{"class":"heart",chance:1e-4,num:1,points:30,lives:2,accel:3}}};f=function(){if(c.debug&&window.console!=null)return arguments.length>1?console.log(Array.prototype.slice.call(arguments)):console.log(arguments[0])};l=window.md5;i=window.btoa;delete window.md5;delete window.atob;delete window.btoa;a=function(e){return e<10?"00"+e:e<100?"0"+e:""+e};r=e(".p-game");d=e(window);p=function(){var t,n,s,c,p,d,v,m,g,y;t=r.find(".game-screen");p=r.find(".game-scoreboard");s=r.find("#game-player-name");m=function(){t.filter(".active").removeClass("active");t.filter(".game-intro").addClass("active");r.trigger("game::intro");return f("game::screens::intro")};g=function(){t.filter(".active").removeClass("active");t.filter(".game-over").addClass("active").find(".game-results-final").html(a(o.score));s.off("keydown",n);r.trigger("game::over");return f("game::screens::over")};v=function(){t.filter(".active").removeClass("active");t.filter(".game-highscore").addClass("active").find(".game-results-final").html(a(o.score));s.on("keydown",n);r.trigger("game::highscore");return f("game::screens::highscore")};d=function(){t.filter(".active").removeClass("active");t.filter(".game-mainscreen").addClass("active");r.trigger("game::started");return f("game::screens::game")};y=function(){var e,t;t=function(){var t,n,r;r=[];for(t=0,n=h.length;t<n;t++){e=h[t];r.push("<li>"+e.name+" "+a(e.score)+"</li>")}return r}();return p.html(t)};c=function(){var t,n,r;if(!((r=e.trim(s.val())).length&&o.score>u))return;n={name:r,score:o.score};h.unshift(n);h.length<=10||(h.length=10);u=o.score;t=JSON.stringify(n);e.ajax({url:"/api/v1.1/game/score.json",data:{signature:l(t),data:i(t)},type:"POST",success:function(e){h=e;return u=h[0].score}});y();return g()};n=function(e){if(e.keyCode===13)return c();if(!/^[a-zA-Z]*$/.test(String.fromCharCode(e.keyCode))&&e.keyCode!==8&&e.keyCode!==46)return e.preventDefault()};y();r.find("#game-start").on("click",d);r.find("#game-retry").on("click",d);r.find("#game-savescore").on("click",c);return{intro:m,over:g,highscore:v,game:d}}();o=function(){var e,t;t={active:!1,score:0,lives:c.lives,mode:0,objects:[],activeObjects:{},player:null,time:Date.now(),delta:0,width:r.width(),height:r.height(),offset:{}};t.reset=function(){o.active=!1;o.score=0;o.lives=c.lives;return o.mode=0};e=function(){var e;e=r.offset();t.offset.x=e.left;return t.offset.y=e.top};e();d.on("resize",e);return t}();t=function(){function t(t,n){this.type=t;this.options=n;this.points=this.options.points;this.lives=this.options.lives;this.chance=this.options.chance;this.velocity=0;this.accelerated=0;this.vector=0;this.randomized=0;this.x=0;this.y=0;this.width=0;this.height=0;this.remove=!1;this.active=!1;this.el=e('<span class="game-object '+this.options["class"]+'"></span>')}t.prototype.getSizes=function(){this.width=this.el.width();return this.height=this.el.height()};t.prototype.activate=function(){this.active=!0;this.el.addClass("active");this.remove||o.activeObjects[this.type]++;(!this.width||!this.height)&&this.getSizes();this.x=Math.random()*(o.width-this.width);return this.y=-Math.random()*o.height};t.prototype.deactivate=function(){this.x=0;this.y=0;this.active=!1;this.el.removeClass("active");this.remove||o.activeObjects[this.type]--;this.velocity=0;return this.vector=0};t.prototype._randomVector=function(){return(Math.random()<.5?this.options.accel:-this.options.accel)*(Math.random()+1)};t.prototype.move=function(){if(o.mode>=c.modes.accelerated-1&&o.time-this.accelerated>150){this.velocity+=this.options.accel;this.accelerated=o.time}o.mode>=c.modes.vector-1&&o.mode<c.modes.randomized-1&&!this.vector&&(this.vector=this._randomVector());if(o.mode>=c.modes.randomized-1&&o.time-this.randomized>300){this.vector+=this._randomVector()*3;this.randomized=o.time}this.y+=c.modes.speeds[o.mode]+this.velocity;this.x+=this.vector;if(this.y>=o.height)return this.deactivate()};t.prototype.render=function(){var e;if(!this.active&&!this.remove){if(o.activeObjects[this.type]>=c.objects[this.type].num)return!1;if(!(Math.random()<this.chance||this.chance===1))return!1;this.activate()}this.move();if(c.transform){e={};e[c.transform]="translate3d("+this.x+"px, "+this.y+"px, 0)"}else e={left:this.x,top:this.y};return this.el.css(e)};return t}();n=function(){function t(){this.x=0;this.y=0;this.el=r.find(".player");this.width=0;this.height=0;this.acceleration=0;this.velocity=0;this.moved=0;this.offset=parseInt(e(this.el).css("margin-top"))}t.prototype.reset=function(){this.width=this.el.width();this.height=this.el.height();this.x=o.width/2-this.el.width()/2;this.y=0;return this.move(0,0)};t.prototype.move=function(e,t){if(e!=null){this.acceleration=e>0?c.player.accel:-c.player.accel;return this.moved=o.time}};t.prototype.render=function(){var e;this.velocity=this.velocity+this.acceleration*o.delta;if(o.time-this.moved>c.player.delay){this.acceleration=this.velocity>0?c.player.accel:-c.player.accel;if(Math.abs(this.velocity)<c.player.limit*.2){this.velocity=0;this.acceleration=0}}this.velocity<-c.player.limit&&(this.velocity=-c.player.limit);this.velocity>c.player.limit&&(this.velocity=c.player.limit);this.x=Math.min(Math.max(0,this.x+this.velocity*o.delta),o.width-this.width);if(c.transform){e={};e[c.transform]="translate3d("+this.x+"px, "+this.y+"px, 0)"}else e={left:this.x,top:this.y};return this.el.css(e)};return t}();s=function(){var i,s,l,h,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F;h=e(document);v=r.find(".game-mainscreen");C=r.find(".game-lives");P=r.find(".game-score");A=r.find(".game-paused");k=Date.now();L=c.modes.speeds.length-1;b=Date.now();m=null;T=function(){var e,r,i,s,u,a;u=c.objects;for(i in u){r=u[i];o.activeObjects[i]=0;for(s=1,a=r.num;1<=a?s<=a:s>=a;1<=a?s++:s--){e=new t(i,r);v.append(e.el);o.objects.push(e)}}return o.player=new n};N=function(){var e,n,r,i;i=[];for(n=1,r=c.sudden.num;1<=r?n<=r:n>=r;1<=r?n++:n--){e=new t(c.sudden.objects[o.mode],c.objects[c.sudden.objects[o.mode]]);e.remove=!0;v.append(e.el);e.activate();i.push(o.objects.push(e))}return i};x=function(){T();r.on("game::started",H);A.on("click",F);return f("game::engine::initialized")};_=function(){var e,t,n,r,i;r=o.objects;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e.deactivate())}return i};l=function(e){if(e.points){o.score=Math.max(o.score+e.points,0);P.html(a(o.score))}if(e.lives){o.lives=Math.min(o.lives+e.lives,c.lives);C.attr("data-lives",o.lives);o.lives<=0&&y()}return e.deactivate()};s=function(e){if(e.y+e.height>=o.player.y+o.player.offset&&e.y<=o.player.y+o.player.offset||e.y>=o.player.y+o.player.offset&&e.y<=o.player.y+o.player.offset+o.player.height)if(e.x<=o.player.x&&e.x+e.width>=o.player.x||e.x>=o.player.x&&e.x<=o.player.x+o.player.width)return l(e)};i=function(){k=o.time;!c.sudden.active||N();o.mode++;return f("game::engine::mode "+(o.mode+1))};w=function(){var e,t,n,r,i,s;b=o.time;n=[];e=0;s=o.objects;for(r=0,i=s.length;r<i;r++){t=s[r];if(t.remove&&!t.active){t.el.remove();e++}else n.push(t)}o.objects=n;return f("game::engine::gc collected: "+e)};M=function(){var e,t,n,r,i;o.player.render();r=o.objects;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];!e.active||s(e);i.push(e.render())}return i};g=function(){var e;if(o.active){m=requestAnimationFrame(g);e=Date.now();o.delta=(o.time-e)*.001;o.time=e;o.time-k>c.modes.time&&L>o.mode&&i();M();if(o.time-b>c.garbage)return w()}};j=function(){return cancelAnimationFrame(m)};E=function(e){switch(e.keyCode){case 27:return F();case 37:return o.player.move(-1,!0);case 39:return o.player.move(1,!0)}};S=function(e){};y=function(){B();return o.score>u?p.highscore():p.over()};F=function(){return o.active?O():D()};H=function(){h.on("keydown",E);h.on("mousemove",S);d.on("blur",O);C.attr("data-lives",o.lives);P.html(a(o.score));k=Date.now();_();o.reset();o.player.reset();o.active=!0;g();return f("game::engine::started")};B=function(){h.off("keydown",E);h.off("mousemove",S);d.off("blur",O);o.active=!1;j();return f("game::engine::stopped")};O=function(){v.addClass("paused");o.active=!1;j();return f("game::engine::paused")};D=function(){v.removeClass("paused");o.active=!0;g();return f("game::engine::resumed")};return{init:x,start:H,stop:B,pause:H,resume:H}}();return s.init()})(jQuery)}).call(this);