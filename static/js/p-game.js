// Generated by CoffeeScript 1.4.0
(function(){(function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;Date.now||(Date.now=function(){return+(new Date)});d=[];a=0;r="api/score.php";p={music:"UBVoONryE3s",debug:!0,lives:6,garbage:5e3,player:{step:10,accel:1},modes:{time:2e4,speeds:[5,8,10,12,16,20,23],accelerated:4,randomized:6,vector:2},sudden:{active:!0,objects:["banana","banana","bomb","heart","banana","bomb"],num:15},transform:S.utils.supports("transform"),objects:{banana:{"class":"banana",chance:.25,num:7,points:1,lives:0,accel:1},bomb:{"class":"bomb",chance:.005,num:3,points:-5,lives:-2,accel:2},heart:{"class":"heart",chance:1e-4,num:1,points:30,lives:2,accel:3}}};l=function(){if(p.debug&&window.console!=null)return arguments.length>1?console.log(Array.prototype.slice.call(arguments)):console.log(arguments[0])};c=window.md5;s=window.btoa;delete window.md5;delete window.atob;delete window.btoa;f=function(e){return e<10?"00"+e:e<100?"0"+e:""+e};i=e(".p-game");m=e(window);v=function(){var t,n,o,h,p,v,m,g,y,b;t=i.find(".game-screen");p=i.find(".game-scoreboard");o=i.find("#game-player-name");g=function(){t.filter(".active").removeClass("active");t.filter(".game-intro").addClass("active");i.trigger("game::intro");return l("game::screens::intro")};y=function(e){t.filter(".active").removeClass("active");t.filter(".game-over").addClass("active").find(".game-results-final").html(f(u.score));e&&o.off("keydown",n);i.trigger("game::over");return l("game::screens::over")};m=function(){t.filter(".active").removeClass("active");t.filter(".game-highscore").addClass("active").find(".game-results-final").html(f(u.score));o.on("keydown",n);i.trigger("game::highscore");return l("game::screens::highscore")};v=function(){t.filter(".active").removeClass("active");t.filter(".game-mainscreen").addClass("active");i.trigger("game::started");return l("game::screens::game")};b=function(){var e,t;t=function(){var t,n,r;r=[];for(t=0,n=d.length;t<n;t++){e=d[t];r.push("<li>"+e.name+" "+f(e.score)+"</li>")}return r}();return p.html(t)};h=function(){var t,n,i;if(!((i=e.trim(o.val())).length&&u.score>a))return;n={name:i,score:u.score};d.unshift(n);d.length<=10||(d.length=10);a=u.score;t=JSON.stringify(n);e.ajax({url:r,data:{signature:c(t),data:s(t)},type:"POST",success:function(e){d=e;return a=d[0].score}});b();return y(!0)};n=function(e){if(e.keyCode===13)return h();if(!/[a-zA-Z]/.test(String.fromCharCode(e.keyCode))&&e.keyCode!==8&&e.keyCode!==46)return e.preventDefault()};i.find("#game-start").on("click",v);i.find("#game-retry").on("click",v);i.find("#game-savescore").on("click",h);e.ajax({url:r,type:"GET",success:function(e){if(e.length){d=e;a=d[0].score;return b()}}});return{intro:g,over:y,highscore:m,game:v}}();u=function(){var e,t;t={active:!1,score:0,lives:p.lives,mode:0,objects:[],activeObjects:{},player:null,time:Date.now(),width:i.width(),height:i.height(),offset:{}};t.reset=function(){u.active=!1;u.score=0;u.lives=p.lives;return u.mode=0};e=function(){var e;e=i.offset();t.offset.x=e.left;return t.offset.y=e.top};e();m.on("resize",e);return t}();t=function(){function t(t,n){this.type=t;this.options=n;this.points=this.options.points;this.lives=this.options.lives;this.chance=this.options.chance;this.velocity=0;this.accelerated=0;this.vector=0;this.randomized=0;this.x=0;this.y=0;this.width=0;this.height=0;this.remove=!1;this.active=!1;this.el=e('<span class="game-object '+this.options["class"]+'"></span>')}t.prototype.getSizes=function(){this.width=this.el.width();return this.height=this.el.height()};t.prototype.activate=function(){this.active=!0;this.el.addClass("active");this.remove||u.activeObjects[this.type]++;(!this.width||!this.height)&&this.getSizes();this.x=Math.random()*(u.width-this.width);return this.y=-Math.random()*u.height};t.prototype.deactivate=function(){this.x=0;this.y=0;this.active=!1;this.el.removeClass("active");this.remove||u.activeObjects[this.type]--;this.velocity=0;return this.vector=0};t.prototype._randomVector=function(){return(Math.random()<.5?this.options.accel:-this.options.accel)*(Math.random()+1)};t.prototype.move=function(){if(u.mode>=p.modes.accelerated-1&&u.time-this.accelerated>150){this.velocity+=this.options.accel;this.accelerated=u.time}u.mode>=p.modes.vector-1&&u.mode<p.modes.randomized-1&&!this.vector&&(this.vector=this._randomVector());if(u.mode>=p.modes.randomized-1&&u.time-this.randomized>300){this.vector+=this._randomVector()*3;this.randomized=u.time}this.y+=p.modes.speeds[u.mode]+this.velocity;this.x+=this.vector;if(this.y>=u.height)return this.deactivate()};t.prototype.render=function(){var e;if(!this.active&&!this.remove){if(u.activeObjects[this.type]>=p.objects[this.type].num)return!1;if(!(Math.random()<this.chance||this.chance===1))return!1;this.activate()}this.move();if(p.transform){e={};e[p.transform]="translate3d("+this.x+"px, "+this.y+"px, 0)"}else e={left:this.x,top:this.y};return this.el.css(e)};return t}();n=function(){function t(){this.x=0;this.y=0;this.el=i.find(".player");this.width=0;this.height=0;this.velocity=0;this.moved=0;this.offset=parseInt(e(this.el).css("margin-top"))}t.prototype.reset=function(){this.width=this.el.width();this.height=this.el.height();this.x=u.width/2-this.el.width()/2;this.y=0;return this.move(0,0)};t.prototype.move=function(e,t){if(e!=null){t?u.time-this.moved<100?this.velocity+=e>0?p.player.accel:-p.player.accel:this.velocity=0:this.velocity=0;this.x=Math.min(Math.max(0,this.x+e+this.velocity),u.width-this.width);return this.moved=u.time}};t.prototype.render=function(){var e;if(p.transform){e={};e[p.transform]="translate3d("+this.x+"px, "+this.y+"px, 0)"}else e={left:this.x,top:this.y};return this.el.css(e)};return t}();o=function(){var r,s,o,c,h,d,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F;c=e(document);h=i.find(".game-mainscreen");C=i.find(".game-lives");P=i.find(".game-score");A=i.find(".game-paused");k=Date.now();L=p.modes.speeds.length-1;b=Date.now();d=null;T=function(){var e,r,i,s,o,a;o=p.objects;for(i in o){r=o[i];u.activeObjects[i]=0;for(s=1,a=r.num;1<=a?s<=a:s>=a;1<=a?s++:s--){e=new t(i,r);h.append(e.el);u.objects.push(e)}}return u.player=new n};N=function(){var e,n,r,i;i=[];for(n=1,r=p.sudden.num;1<=r?n<=r:n>=r;1<=r?n++:n--){e=new t(p.sudden.objects[u.mode],p.objects[p.sudden.objects[u.mode]]);e.remove=!0;h.append(e.el);e.activate();i.push(u.objects.push(e))}return i};x=function(){T();i.on("game::started",H);A.on("click",F);return l("game::engine::initialized")};_=function(){var e,t,n,r,i;r=u.objects;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e.deactivate())}return i};o=function(e){if(e.points){u.score=Math.max(u.score+e.points,0);P.html(f(u.score))}if(e.lives){u.lives=Math.min(u.lives+e.lives,p.lives);C.attr("data-lives",u.lives);u.lives<=0&&y()}return e.deactivate()};s=function(e){if(e.y+e.height>=u.player.y+u.player.offset&&e.y<=u.player.y+u.player.offset||e.y>=u.player.y+u.player.offset&&e.y<=u.player.y+u.player.offset+u.player.height)if(e.x<=u.player.x&&e.x+e.width>=u.player.x||e.x>=u.player.x&&e.x<=u.player.x+u.player.width)return o(e)};r=function(){k=u.time;!p.sudden.active||N();u.mode++;return l("game::engine::mode "+(u.mode+1))};w=function(){var e,t,n,r,i,s;b=u.time;n=[];e=0;s=u.objects;for(r=0,i=s.length;r<i;r++){t=s[r];if(t.remove&&!t.active){t.el.remove();e++}else n.push(t)}u.objects=n;return l("game::engine::gc collected: "+e)};M=function(){var e,t,n,r,i;u.player.render();r=u.objects;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];!e.active||s(e);i.push(e.render())}return i};g=function(){if(u.active){d=requestAnimationFrame(g);u.time=Date.now();u.time-k>p.modes.time&&L>u.mode&&r();M()}if(u.time-b>p.garbage)return w()};j=function(){return cancelAnimationFrame(d)};E=function(e){switch(e.keyCode){case 27:return F();case 37:return u.player.move(-p.player.step,!0);case 39:return u.player.move(p.player.step,!0)}};S=function(e){return u.player.move(e.pageX-u.player.x-u.player.width/2-u.offset.x)};y=function(){B();return u.score>a?v.highscore():v.over()};F=function(){return u.active?O():D()};H=function(){c.on("keydown",E);c.on("mousemove",S);m.on("blur",O);C.attr("data-lives",u.lives);P.html(f(u.score));k=Date.now();_();u.reset();u.player.reset();u.active=!0;g();return l("game::engine::started")};B=function(){c.off("keydown",E);c.off("mousemove",S);m.off("blur",O);u.active=!1;j();return l("game::engine::stopped")};O=function(){h.addClass("paused");u.active=!1;j();return l("game::engine::paused")};D=function(){h.removeClass("paused");u.active=!0;g();return l("game::engine::resumed")};return{init:x,start:H,stop:B,pause:H,resume:H}}();h=function(){var t,n;n='<iframe type="text/html" width="1" height="1"                     src="http://www.youtube.com/embed/'+p.music+'?autoplay=1&amp;loop=1&amp;fmt=18&amp;wmode=transparent&amp;rel=0"                    wmode="transparent"                    allowscriptaccess                    frameborder="0">                </iframe>';t=function(){return e("body").append(n)};return{init:t}}();o.init();if(p.music)return h.init()})(jQuery)}).call(this);